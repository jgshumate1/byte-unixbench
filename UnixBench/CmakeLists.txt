
cmake_minimum_required(VERSION 3.16)
project(unixbench C)

# -------- Options / Configuration --------
option(BUILD_GRAPHIC_TESTS "Build OpenGL/X11 graphics test (ubgears)" OFF)
option(UB_NATIVE_TUNING "Enable native CPU tuning flags similar to the Makefile" OFF)

# Default tick rate for Dhrystone (override with -DHZ=...)
set(HZ "100" CACHE STRING "Timer ticks per second for Dhrystone")

# Source tree layout
set(SRCDIR "${CMAKE_CURRENT_SOURCE_DIR}/src")

# Place all executables under build/pgms (similar to PROGDIR = ./pgms)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/pgms")

# C standard
set(CMAKE_C_STANDARD 99)
set(CMAKE_C_STANDARD_REQUIRED ON)

# Common warnings and optimization (mirrors: -Wall -pedantic -O3 -ffast-math)
add_compile_options(-Wall -pedantic -O3 -ffast-math)

# -DTIME must be defined globally (per Makefile)
add_compile_definitions(TIME)

# Add include directory (mirrors: -I $(SRCDIR))
include_directories("${SRCDIR}")

# -------- OS / CPU-specific tuning (mirrors Makefile uname logic) --------
if(UB_NATIVE_TUNING)
  if(CMAKE_SYSTEM_NAME STREQUAL "Linux")
    if(CMAKE_SYSTEM_PROCESSOR MATCHES "ppc64|ppc64le")
      add_compile_options(-mcpu=native -mtune=native)
    elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "riscv64")
      # Mirrors: -march=rv64g -mabi=lp64d
      add_compile_options(-march=rv64g -mabi=lp64d)
    else()
      add_compile_options(-march=native -mtune=native)
    endif()
  elseif(CMAKE_SYSTEM_NAME STREQUAL "Darwin")
    if(CMAKE_SYSTEM_PROCESSOR MATCHES "ppc64|ppc64le")
      add_compile_options(-mcpu=native)
    else()
      # Requires compatible SDK; mirror Makefile behavior
      add_compile_options(-march=native -mmacosx-version-min=10.10)
    endif()
    # As in Makefile comment for XCode/OS X assemblers
    add_compile_options(-Wa,-q)
  endif()
endif()

# -------- Helper: link m on UNIX-like systems --------
if(UNIX AND NOT APPLE)
  set(M_LIB m)
elseif(APPLE)
  # libm is part of libSystem on macOS; keep empty (linker handles it).
  set(M_LIB "")
endif()

# -------- Executable Targets (mirroring Makefile) --------

# arith.c variants
add_executable(arithoh       ${SRCDIR}/arith.c ${SRCDIR}/timeit.c)
target_compile_definitions(arithoh       PRIVATE arithoh)

set(DATA_TYPES "char" "short" "int" "long" "double" "float" "register")

foreach(T IN LISTS DATA_TYPES)
    # 1. Create a unique target name for each type
    set(EXE_NAME "app_${T}")

    add_executable(${EXE_NAME} ${SRCDIR}/arith.c ${SRCDIR}/timeit.c)
    target_compile_definitions(${EXE_NAME} PRIVATE MY_TYPE=${T})
    
    # Optional: Set the final output name to something specific
    # set_target_properties(${EXE_NAME} PROPERTIES OUTPUT_NAME "program_${T}")
endforeach()

#add_executable(register      ${SRCDIR}/arith.c ${SRCDIR}/timeit.c)
#target_compile_definitions(register      PRIVATE MY_TYPE="register int")

#add_executable(short         ${SRCDIR}/arith.c ${SRCDIR}/timeit.c)
#target_compile_definitions(short         PRIVATE datum=short)

#add_executable(int           ${SRCDIR}/arith.c ${SRCDIR}/timeit.c)
#target_compile_definitions(int           PRIVATE datum=int)

#add_executable(long          ${SRCDIR}/arith.c ${SRCDIR}/timeit.c)
#target_compile_definitions(long          PRIVATE datum=long)

#add_executable(float         ${SRCDIR}/arith.c ${SRCDIR}/timeit.c)
#target_compile_definitions(float         PRIVATE datum=float)

#add_executable(double        ${SRCDIR}/arith.c ${SRCDIR}/timeit.c)
#target_compile_definitions(double        PRIVATE datum=double)

# polling variants are platform-specific in the Makefile; left disabled by default.
# To enable, uncomment and add the desired macros.
# add_executable(poll   ${SRCDIR}/time-polling.c)
# target_compile_definitions(poll PRIVATE UNIXBENCH HAS_POLL)
# add_executable(poll2  ${SRCDIR}/time-polling.c)
# target_compile_definitions(poll2 PRIVATE UNIXBENCH HAS_POLL2)
# add_executable(select ${SRCDIR}/time-polling.c)
# target_compile_definitions(select PRIVATE UNIXBENCH HAS_SELECT)

# Whetstone (double)
add_executable(whetstone-double ${SRCDIR}/whets.c)
target_compile_definitions(whetstone-double PRIVATE DP GTODay UNIXBENCH)
target_link_libraries(whetstone-double PRIVATE ${M_LIB})

# Other simple targets
add_executable(pipe     ${SRCDIR}/pipe.c     ${SRCDIR}/timeit.c)
#add_executable(execl    ${SRCDIR}/execl.c    ${SRCDIR}/big.c)
add_executable(spawn    ${SRCDIR}/spawn.c    ${SRCDIR}/timeit.c)
add_executable(hanoi    ${SRCDIR}/hanoi.c    ${SRCDIR}/timeit.c)
add_executable(fstime   ${SRCDIR}/fstime.c)
add_executable(syscall  ${SRCDIR}/syscall.c  ${SRCDIR}/timeit.c)
add_executable(context1 ${SRCDIR}/context1.c ${SRCDIR}/timeit.c)
add_executable(looper   ${SRCDIR}/looper.c   ${SRCDIR}/timeit.c)

# ubgears (OpenGL/X11) — only if requested
if(BUILD_GRAPHIC_TESTS)
  find_package(OpenGL REQUIRED)
  # X11: ask for core + Xext to match -lX11 -lXext
  find_package(X11 REQUIRED)
  if(NOT X11_Xext_FOUND AND DEFINED X11_Xext_LIB)
    # Some CMake versions don't populate a 'FOUND' var for Xext; we’ll still use the lib var.
    set(X11_Xext_FOUND TRUE)
  endif()

  add_executable(ubgears ${SRCDIR}/ubgears.c)
  # Link order consistent with GL + X11 + math
  if(X11_Xext_FOUND AND X11_Xext_LIB)
    target_link_libraries(ubgears PRIVATE ${M_LIB} OpenGL::GL ${X11_X11_LIB} ${X11_Xext_LIB})
  else()
    target_link_libraries(ubgears PRIVATE ${M_LIB} OpenGL::GL ${X11_X11_LIB})
  endif()
endif()

# Dhrystone (special compile defs, only dhry_1.c and dhry_2.c are compiled)
add_executable(dhry2    ${SRCDIR}/dhry_1.c ${SRCDIR}/dhry_2.c ${SRCDIR}/timeit.c)
target_compile_definitions(dhry2 PRIVATE HZ=${HZ})

add_executable(dhry2reg ${SRCDIR}/dhry_1.c ${SRCDIR}/dhry_2.c ${SRCDIR}/timeit.c)
target_compile_definitions(dhry2reg PRIVATE HZ=${HZ} REG=register)

# -------- Convenience: group the typical benchmark targets --------
set(UB_PROGRAMS
  arithoh register short int long float double
  hanoi syscall context1 pipe spawn execl
  dhry2 dhry2reg looper fstime whetstone-double
)

if(BUILD_GRAPHIC_TESTS)
  list(APPEND UB_PROGRAMS ubgears)
endif()

add_custom_target(programs DEPENDS ${UB_PROGRAMS})
